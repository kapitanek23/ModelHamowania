<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Symulacja hamowania – tabela wyników</title>
  <!-- Załączamy Plotly z CDN -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    /* Kontener na wykres */
    #plotContainer {
      position: relative;
      width: 800px;
      height: 500px;
    }
    /* Licznik prędkości i siły w rogu wykresu */
    #infoDisplay {
      position: absolute;
      right: 20px;
      top: 20px;
      background-color: rgba(255,255,255,0.8);
      padding: 5px 10px;
      border: 1px solid #999;
      border-radius: 5px;
      font-weight: bold;
      z-index: 9999; /* aby był nad wykresem */
    }
    /* Tabela wyników */
    #resultsTable table {
      border-collapse: collapse;
      margin-top: 20px;
    }
    #resultsTable th, #resultsTable td {
      border: 1px solid #ccc;
      padding: 5px 10px;
      text-align: center;
    }
    #resultsTable th {
      background-color: #eee;
    }
  </style>
</head>
<body>

<h1>Symulacja spowolnienia pojazdu (z tabelą wyników)</h1>

<form id="paramForm">
  <label>Początkowa prędkość v0:</label>
  <input type="number" id="v0" value="30" step="0.1">
  <br><br>

  <label>Jednostka prędkości (wejściowa):</label>
  <input type="radio" name="velocityUnitInput" value="ms" checked> m/s
  <input type="radio" name="velocityUnitInput" value="kmh"> km/h
  <br><br>

  <label>Krok czasowy dt (s):</label>
  <input type="number" id="dt" value="0.1" step="0.01">
  <br><br>

  <label>Współczynnik oporu c:</label>
  <input type="number" id="c" value="0.1" step="0.01">
  <br><br>

  <label>Masa pojazdu m (kg):</label>
  <input type="number" id="mass" value="1000" step="10">
  <br><br>

  <label>Maksymalny czas t_max (s):</label>
  <input type="number" id="t_max" value="60" step="1">
  <br><br>

  <label>Jednostka prędkości (wyjściowa):</label>
  <input type="radio" name="velocityUnitOutput" value="ms" checked> m/s
  <input type="radio" name="velocityUnitOutput" value="kmh"> km/h
  <br><br>

  <button type="button" id="simulateBtn">Symuluj</button>
  <button type="button" id="clearBtn">Wyczyść</button>
</form>

<hr>

<div id="plotContainer">
  <div id="myPlot" style="width: 100%; height: 100%;"></div>
  <!-- Tu wyświetlamy prędkość i siłę -->
  <div id="infoDisplay">
    Prędkość: --<br>
    Siła: --
  </div>
</div>

<!-- Kontener, w którym wstawimy tabelę z wynikami -->
<div id="resultsTable"></div>

<script>
  let simulationTimer = null;

  document.getElementById('simulateBtn').addEventListener('click', function() {
    // Kasujemy ewentualny poprzedni timer
    if (simulationTimer) {
      clearInterval(simulationTimer);
      simulationTimer = null;
    }

    // Czyścimy poprzedni wykres
    Plotly.purge('myPlot');
    document.getElementById('infoDisplay').innerHTML = `Prędkość: --<br>Siła: --`;

    // Czyścimy poprzednią tabelę wyników (o ile jest)
    document.getElementById('resultsTable').innerHTML = '';

    // Pobieramy dane z formularza
    const v0Input = parseFloat(document.getElementById('v0').value);
    const dt = parseFloat(document.getElementById('dt').value);
    const c = parseFloat(document.getElementById('c').value);
    const m = parseFloat(document.getElementById('mass').value);
    const t_max = parseFloat(document.getElementById('t_max').value);

    // Wejściowa jednostka prędkości
    const velocityUnitInput = document.querySelector('input[name="velocityUnitInput"]:checked').value;
    let v0_ms = v0Input;
    if (velocityUnitInput === 'kmh') {
      v0_ms = v0_ms / 3.6;
    }

    // Wyjściowa jednostka prędkości
    const velocityUnitOutput = document.querySelector('input[name="velocityUnitOutput"]:checked').value;

    // Budujemy URL do /data
    const url = `/data?v0=${v0_ms}&dt=${dt}&c=${c}&m=${m}&t_max=${t_max}`;

    fetch(url)
      .then(response => response.json())
      .then(data => {
        const time = data.time;           // [s]
        const velocitySI = data.velocity; // [m/s]
        // Konwertujemy do km/h, jeśli trzeba
        let velocityOut = [...velocitySI];
        if (velocityUnitOutput === 'kmh') {
          velocityOut = velocityOut.map(v => v * 3.6);
        }

        // Obliczamy siły oporu (F_drag = c * v^2) w [N]
        // (tutaj v - w [m/s])
        const dragForces = velocitySI.map(v => c * v * v);

        // Tablice na dane do rysowania
        const xData = [];
        const yData = [];

        // Główny trace: jedna, niebieska linia
        const traceMain = {
          x: xData,
          y: yData,
          mode: 'lines',
          line: {
            color: 'blue',
            width: 3
          },
          name: 'Prędkość'
        };

        // Tworzymy wykres (na razie pusty)
        const layout = {
          title: 'Prędkość pojazdu w czasie',
          xaxis: { title: 'Czas [s]' },
          yaxis: {
            title: (velocityUnitOutput === 'kmh')
              ? 'Prędkość [km/h]' 
              : 'Prędkość [m/s]'
          }
        };

        Plotly.newPlot('myPlot', [traceMain], layout);

        // ANIMACJA: co 50 ms dodajemy jeden punkt
        let currentIndex = 0;
        const intervalMs = 50;
        const totalPoints = time.length;

        simulationTimer = setInterval(() => {
          if (currentIndex >= totalPoints) {
            clearInterval(simulationTimer);
            simulationTimer = null;

            // Kiedy skończy się animacja, tworzymy TABELĘ wyników:
            generateResultsTable();

            return;
          }

          // Doklejamy kolejne punkty
          xData.push(time[currentIndex]);
          yData.push(velocityOut[currentIndex]);

          // Aktualizujemy wykres (trace #0)
          Plotly.update('myPlot', {
            x: [xData],
            y: [yData]
          }, {}, [0]);

          // Wyświetlamy prędkość i siłę w rogu
          const speedValue = velocityOut[currentIndex].toFixed(2);
          const forceValue = dragForces[currentIndex].toFixed(2);

          document.getElementById('infoDisplay').innerHTML =
            `Prędkość: ${speedValue} ${(velocityUnitOutput === 'kmh') ? 'km/h' : 'm/s'}<br>` +
            `Siła: ${forceValue} N`;

          currentIndex++;
        }, intervalMs);

        // Funkcja, która po zakończeniu animacji generuje tabelę
        function generateResultsTable() {
          // Budujemy HTML w postaci <table> z <thead> i <tbody>
          let html = `
            <table>
              <thead>
                <tr>
                  <th>Nr iteracji</th>
                  <th>Czas [s]</th>
                  <th>Prędkość [${(velocityUnitOutput === 'kmh') ? 'km/h' : 'm/s'}]</th>
                  <th>Δ Prędkość</th>
                  <th>Siła [N]</th>
                  <th>Δ Siła</th>
                </tr>
              </thead>
              <tbody>
          `;

          for (let i = 0; i < time.length; i++) {
            // Czas
            const tVal = time[i].toFixed(2);
            // Prędkość (w wybranej jednostce, 2 miejsca po przecinku)
            const vVal = velocityOut[i].toFixed(2);
            // Zmiana prędkości w stosunku do poprzedniego punktu:
            // (pierwszy punkt -> brak poprzedniego, więc 0)
            let dv = 0.0;
            if (i > 0) {
              dv = velocityOut[i] - velocityOut[i - 1];
            }
            const dvVal = dv.toFixed(2);

            // Siła
            const fVal = dragForces[i].toFixed(2);
            // Zmiana siły
            let df = 0.0;
            if (i > 0) {
              df = dragForces[i] - dragForces[i - 1];
            }
            const dfVal = df.toFixed(2);

            html += `
              <tr>
                <td>${i}</td>
                <td>${tVal}</td>
                <td>${vVal}</td>
                <td>${dvVal}</td>
                <td>${fVal}</td>
                <td>${dfVal}</td>
              </tr>
            `;
          }

          html += `</tbody></table>`;

          // Wstawiamy tabelę do #resultsTable
          document.getElementById('resultsTable').innerHTML = html;
        }
      })
      .catch(err => console.error(err));
  });

  // Obsługa przycisku „Wyczyść”
  document.getElementById('clearBtn').addEventListener('click', function() {
    if (simulationTimer) {
      clearInterval(simulationTimer);
      simulationTimer = null;
    }
    Plotly.purge('myPlot');
    document.getElementById('infoDisplay').innerHTML = `Prędkość: --<br>Siła: --`;
    document.getElementById('resultsTable').innerHTML = '';

    // Reset formularza do wartości domyślnych
    document.getElementById('v0').value = '30';
    document.getElementById('dt').value = '0.1';
    document.getElementById('c').value = '0.1';
    document.getElementById('mass').value = '1000';
    document.getElementById('t_max').value = '60';

    document.querySelector('input[name="velocityUnitInput"][value="ms"]').checked = true;
    document.querySelector('input[name="velocityUnitOutput"][value="ms"]').checked = true;
  });
</script>

</body>
</html>
